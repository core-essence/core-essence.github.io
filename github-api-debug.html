<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub API ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .test-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #495057;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success {
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .error {
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .info {
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        
        .warning {
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        #results {
            margin-top: 30px;
        }
        
        .step-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .step-indicator.success {
            background: #28a745;
        }
        
        .step-indicator.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” GitHub API ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="test-section">
            <h2><span class="step-indicator" id="step1">1</span>è¨­å®šç¢ºèª</h2>
            <div class="input-group">
                <label>GitHubãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰.txtã‹ã‚‰ï¼‰</label>
                <input type="password" id="githubToken" value="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">
            </div>
            <div class="input-group">
                <label>ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼</label>
                <input type="text" id="repoOwner" value="aminati-ec">
            </div>
            <div class="input-group">
                <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
                <input type="text" id="repoName" value="aminati-ec.github.io">
            </div>
            <div class="input-group">
                <label>ãƒ–ãƒ©ãƒ³ãƒå</label>
                <input type="text" id="branchName" value="main">
            </div>
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2><span class="step-indicator" id="step2">2</span>ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ç¢ºèª</h2>
            <button onclick="testTokenPermissions()" disabled id="permTestBtn">ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2><span class="step-indicator" id="step3">3</span>ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testReadFile()" disabled id="readTestBtn">index.html ã‚’èª­ã¿è¾¼ã‚€</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2><span class="step-indicator" id="step4">4</span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testUploadFile()" disabled id="uploadTestBtn">ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <div id="result4" class="result" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2><span class="step-indicator" id="step5">5</span>å•é¡Œã®è¨ºæ–­çµæœ</h2>
            <div id="diagnosis" class="result warning" style="display:none;"></div>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let config = {};
        let testResults = {
            connection: false,
            permissions: false,
            read: false,
            upload: false
        };
        
        // è¨­å®šã‚’å–å¾—
        function getConfig() {
            return {
                token: document.getElementById('githubToken').value,
                owner: document.getElementById('repoOwner').value,
                repo: document.getElementById('repoName').value,
                branch: document.getElementById('branchName').value
            };
        }
        
        // çµæœè¡¨ç¤º
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
        function updateStep(stepId, status) {
            const element = document.getElementById(stepId);
            element.className = `step-indicator ${status}`;
        }
        
        // 1. æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            config = getConfig();
            showResult('result1', 'ãƒ†ã‚¹ãƒˆä¸­...', 'info');
            
            try {
                // ã¾ãšã¯GitHub APIã®åŸºæœ¬çš„ãªæ¥ç¶šç¢ºèª
                const response = await fetch('https://api.github.com', {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showResult('result1', 'âœ… GitHub APIã¸ã®æ¥ç¶š: æˆåŠŸ\n\næ¬¡ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚', 'success');
                    updateStep('step1', 'success');
                    testResults.connection = true;
                    document.getElementById('permTestBtn').disabled = false;
                } else {
                    throw new Error(`GitHub APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
            } catch (error) {
                showResult('result1', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStep('step1', 'error');
                showDiagnosis();
            }
        }
        
        // 2. ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ç¢ºèª
        async function testTokenPermissions() {
            showResult('result2', 'ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªä¸­...', 'info');
            
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ç¢ºèªï¼‰
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    // Bearerå½¢å¼ã‚‚è©¦ã™
                    const response2 = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `Bearer ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response2.ok) {
                        throw new Error(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${response.status} - ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™`);
                    }
                    
                    const userData = await response2.json();
                    showResult('result2', `âœ… ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹ï¼ˆBearerå½¢å¼ï¼‰\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userData.login}\n\nâš ï¸ æ³¨æ„: Bearerå½¢å¼ã§ã®èªè¨¼ãŒå¿…è¦ã§ã™`, 'warning');
                } else {
                    const userData = await response.json();
                    
                    // ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
                    const repoResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}`, {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (repoResponse.ok) {
                        showResult('result2', `âœ… ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userData.login}\nãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹: OK`, 'success');
                        updateStep('step2', 'success');
                        testResults.permissions = true;
                        document.getElementById('readTestBtn').disabled = false;
                    } else {
                        throw new Error('ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                }
            } catch (error) {
                showResult('result2', `âŒ ${error.message}`, 'error');
                updateStep('step2', 'error');
                showDiagnosis();
            }
        }
        
        // 3. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        async function testReadFile() {
            showResult('result3', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/index.html?ref=${config.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('result3', `âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ\nãƒ•ã‚¡ã‚¤ãƒ«: index.html\nã‚µã‚¤ã‚º: ${data.size} bytes\nSHA: ${data.sha.substring(0, 7)}...`, 'success');
                    updateStep('step3', 'success');
                    testResults.read = true;
                    document.getElementById('uploadTestBtn').disabled = false;
                } else if (response.status === 404) {
                    showResult('result3', `âš ï¸ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ãƒªãƒã‚¸ãƒˆãƒªã®å¯èƒ½æ€§ï¼‰\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã™ã€‚`, 'warning');
                    updateStep('step3', 'success');
                    testResults.read = true;
                    document.getElementById('uploadTestBtn').disabled = false;
                } else {
                    throw new Error(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
            } catch (error) {
                showResult('result3', `âŒ ${error.message}`, 'error');
                updateStep('step3', 'error');
                showDiagnosis();
            }
        }
        
        // 4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        async function testUploadFile() {
            showResult('result4', 'ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
            
            try {
                const testContent = `<!DOCTYPE html>
<html>
<head>
    <title>GitHub API Test</title>
</head>
<body>
    <h1>ãƒ†ã‚¹ãƒˆæˆåŠŸï¼</h1>
    <p>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ ${new Date().toLocaleString()} ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚</p>
</body>
</html>`;
                
                const contentBase64 = btoa(unescape(encodeURIComponent(testContent)));
                const testPath = `test/api-test-${Date.now()}.html`;
                
                // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆæ–°è¦ä½œæˆã®ãŸã‚ã€å­˜åœ¨ã—ãªã„ã“ã¨ã‚’æœŸå¾…ï¼‰
                const checkResponse = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${testPath}?ref=${config.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                let sha = null;
                if (checkResponse.ok) {
                    const existingFile = await checkResponse.json();
                    sha = existingFile.sha;
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const uploadResponse = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${testPath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Test upload at ${new Date().toLocaleString()}`,
                            content: contentBase64,
                            branch: config.branch,
                            ...(sha ? { sha } : {})
                        })
                    }
                );
                
                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    showResult('result4', `âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼\n\nãƒ•ã‚¡ã‚¤ãƒ«: ${testPath}\nã‚³ãƒŸãƒƒãƒˆ: ${result.commit.sha.substring(0, 7)}...\nURL: https://${config.owner}.github.io/${testPath}\n\nğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼`, 'success');
                    updateStep('step4', 'success');
                    testResults.upload = true;
                    showDiagnosis();
                } else {
                    const errorData = await uploadResponse.text();
                    throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${uploadResponse.status}\n${errorData}`);
                }
            } catch (error) {
                showResult('result4', `âŒ ${error.message}`, 'error');
                updateStep('step4', 'error');
                showDiagnosis();
            }
        }
        
        // è¨ºæ–­çµæœã‚’è¡¨ç¤º
        function showDiagnosis() {
            let diagnosis = 'ğŸ“Š è¨ºæ–­çµæœ:\n\n';
            
            if (!testResults.connection) {
                diagnosis += 'âŒ GitHub APIã¸ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n';
                diagnosis += '  â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n';
            }
            
            if (testResults.connection && !testResults.permissions) {
                diagnosis += 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n';
                diagnosis += '  â†’ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã¾ãŸã¯ç„¡åŠ¹ã§ã™ã€‚\n';
                diagnosis += '  â†’ æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n';
                diagnosis += '  â†’ å¿…è¦ãªæ¨©é™: repo (Full control of private repositories)\n\n';
            }
            
            if (testResults.permissions && !testResults.read) {
                diagnosis += 'âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n';
                diagnosis += '  â†’ ãƒ–ãƒ©ãƒ³ãƒåãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆmain or masterï¼‰\n';
                diagnosis += '  â†’ ãƒªãƒã‚¸ãƒˆãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n';
            }
            
            if (testResults.read && !testResults.upload) {
                diagnosis += 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n';
                diagnosis += '  â†’ ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n';
                diagnosis += '  â†’ GitHub APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\n';
            }
            
            if (testResults.upload) {
                diagnosis += 'âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼\n\n';
                diagnosis += 'ğŸ“ product-generator.jsã®ä¿®æ­£ç‚¹:\n';
                diagnosis += '1. Bearerå½¢å¼ã®èªè¨¼ã«å¤‰æ›´ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“\n';
                diagnosis += '2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ãŒå¿…è¦ã§ã™\n';
                diagnosis += '3. Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“\n\n';
                diagnosis += 'ğŸ’¡ æ¨å¥¨äº‹é …:\n';
                diagnosis += '- ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç’°å¢ƒå¤‰æ•°ã‚„è¨­å®šç”»é¢ã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´\n';
                diagnosis += '- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¿½åŠ \n';
                diagnosis += '- é€²æ—çŠ¶æ³ã®è¡¨ç¤ºã‚’æ”¹å–„';
            }
            
            showResult('diagnosis', diagnosis, testResults.upload ? 'success' : 'warning');
            updateStep('step5', testResults.upload ? 'success' : 'error');
        }
    </script>
</body>
</html>