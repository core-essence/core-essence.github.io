<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - AMINATI_EC</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        /* å•†å“ç®¡ç†å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 { 
            color: #333; 
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 6px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .csv-import-area {
            display: none;
            margin-bottom: 20px;
            padding: 20px;
            background: #e8f4f8;
            border: 2px dashed #17a2b8;
            border-radius: 6px;
            text-align: center;
        }
        
        .csv-import-area.active {
            display: block;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .product-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .product-table th {
            background: #000;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .product-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .product-table tr:hover {
            background: #f8f9fa;
        }
        
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .product-number-cell {
            width: 80px;
            font-family: monospace;
        }
        
        .brand-cell {
            width: 120px;
        }
        
        .name-cell {
            min-width: 200px;
        }
        
        .name-cell a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }
        
        .name-cell a:hover {
            color: #007bff;
            text-decoration: underline;
        }
        
        .price-cell {
            width: 100px;
            text-align: right;
            font-family: monospace;
        }
        
        .colors-cell, .sizes-cell {
            width: 80px;
            text-align: center;
        }
        
        /* é¸æŠã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
        .selection-info {
            font-size: 14px;
            color: #666;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #666;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ */
        .loading::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-products {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
        #csvFileInput {
            display: none;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="header-content">
            <div>
                <span class="admin-logo">AMINATI_EC</span>
                <span class="admin-badge">å•†å“ç®¡ç†</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn btn-secondary" onclick="location.href='admin.html'" style="padding: 8px 16px; font-size: 14px;">
                    â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹
                </button>
                <button class="btn btn-primary" onclick="location.href='index.html'" style="padding: 8px 16px; font-size: 14px;">
                    ğŸ  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª
                </button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="container">
            <h1>ä¿å­˜æ¸ˆã¿å•†å“ä¸€è¦§</h1>
            
            <div class="action-bar">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="selectAll()">
                        <span id="selectAllText">å…¨é¸æŠ</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelected()">
                        é¸æŠã‚’å‰Šé™¤
                    </button>
                    <button class="btn btn-success" onclick="exportToCSV()">
                        CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-secondary" onclick="toggleImportArea()">
                        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                </div>
                <div class="selection-info">
                    <span id="selectedCount">0</span>ä»¶é¸æŠä¸­
                </div>
            </div>
            
            <div class="csv-import-area" id="csvImportArea">
                <p>å•†å“æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    â€» CSVã«ã¯ã€Œå•†å“ç•ªå·ã€åˆ—ãŒå¿…é ˆã§ã™ã€‚æ›´æ–°ã—ãŸã„é …ç›®ã®åˆ—ã®ã¿å«ã‚ã¦ãã ã•ã„ã€‚
                </p>
                <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVFile(this.files[0])">
                <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
            </div>
            
            <table class="product-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>
                        <th>å•†å“ç•ªå·</th>
                        <th>ãƒ–ãƒ©ãƒ³ãƒ‰</th>
                        <th>å•†å“å</th>
                        <th>è²©å£²ä¾¡æ ¼</th>
                        <th>ã‚«ãƒ©ãƒ¼æ•°</th>
                        <th>ã‚µã‚¤ã‚ºæ•°</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <!-- å•†å“ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«æŒ¿å…¥ -->
                </tbody>
            </table>
            
            <div class="no-products" id="noProducts" style="display: none;">
                <p>è¡¨ç¤ºã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <button class="btn btn-primary" onclick="location.href='admin.html'" style="margin-top: 20px;">
                    å•†å“ç™»éŒ²ç”»é¢ã¸
                </button>
            </div>
            
            <div class="loading" id="loading">
                å‡¦ç†ä¸­...
            </div>
        </div>
    </main>
    
    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ProductStorageã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
        class ProductStorage {
            constructor() {
                this.dbName = 'AminatiECProducts';
                this.storeName = 'products';
                this.version = 2; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’2ã«å¤‰æ›´
            }
            
            async openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const objectStore = db.createObjectStore(this.storeName, { keyPath: 'productNumber' });
                            objectStore.createIndex('createdAt', 'createdAt', { unique: false });
                            objectStore.createIndex('updatedAt', 'updatedAt', { unique: false });
                        }
                    };
                });
            }
            
            async saveProduct(productNumber, html, productData) {
                const db = await this.openDB();
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                
                const product = {
                    productNumber: productNumber,
                    html: html,
                    productData: productData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                return new Promise((resolve, reject) => {
                    const request = store.put(product);
                    request.onsuccess = () => resolve(product);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getProduct(productNumber) {
                const db = await this.openDB();
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = store.get(productNumber);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllProducts() {
                const db = await this.openDB();
                const transaction = db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async deleteProduct(productNumber) {
                const db = await this.openDB();
                const transaction = db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = store.delete(productNumber);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }
    </script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allProducts = [];
        let selectedProducts = new Set();
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
        });
        
        // å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadProducts() {
            showLoading();
            
            try {
                const storage = new ProductStorage();
                allProducts = await storage.getAllProducts();
                
                console.log('èª­ã¿è¾¼ã‚“ã å•†å“æ•°:', allProducts.length);
                
                if (allProducts.length === 0) {
                    document.getElementById('productTableBody').innerHTML = '';
                    document.getElementById('noProducts').style.display = 'block';
                    hideLoading();
                    return;
                }
                
                displayProducts();
                hideLoading();
                
            } catch (error) {
                console.error('å•†å“ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
                alert('å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // å•†å“ã®è¡¨ç¤º
        function displayProducts() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            
            allProducts.forEach(p => {
                const hasDiscount = p.productData.originalPrice && p.productData.originalPrice != p.productData.salePrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="product-checkbox" data-product-number="${escapeHtml(p.productNumber)}">
                    </td>
                    <td class="product-number-cell">${escapeHtml(p.productNumber)}</td>
                    <td class="brand-cell">${escapeHtml(p.productData.brandName || 'ãƒãƒ¼ãƒ–ãƒ©ãƒ³ãƒ‰')}</td>
                    <td class="name-cell">
                        <a href="#" onclick="viewProduct('${escapeHtml(p.productNumber)}'); return false;">${escapeHtml(p.productData.productName)}</a>
                    </td>
                    <td class="price-cell">Â¥${formatNumber(p.productData.salePrice)}</td>
                    <td class="colors-cell">${(p.productData.colors || []).length}è‰²</td>
                    <td class="sizes-cell">${(p.productData.sizes || []).length}ã‚µã‚¤ã‚º</td>
                `;
                tbody.appendChild(row);
            });
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedProducts.add(this.dataset.productNumber);
                    } else {
                        selectedProducts.delete(this.dataset.productNumber);
                    }
                    updateSelectionInfo();
                });
            });
        }
        
        // å…¨é¸æŠ/è§£é™¤
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedProducts.add(checkbox.dataset.productNumber);
                } else {
                    selectedProducts.delete(checkbox.dataset.productNumber);
                }
            });
            
            updateSelectionInfo();
        }
        
        // å…¨é¸æŠãƒœã‚¿ãƒ³
        function selectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = !selectAllCheckbox.checked;
            toggleSelectAll();
        }
        
        // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
        function updateSelectionInfo() {
            document.getElementById('selectedCount').textContent = selectedProducts.size;
            document.getElementById('selectAllText').textContent = 
                selectedProducts.size === allProducts.length ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ';
        }
        
        // é¸æŠã—ãŸå•†å“ã‚’å‰Šé™¤
        async function deleteSelected() {
            if (selectedProducts.size === 0) {
                alert('å‰Šé™¤ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`é¸æŠã—ãŸ${selectedProducts.size}ä»¶ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            showLoading();
            
            try {
                const storage = new ProductStorage();
                
                for (const productNumber of selectedProducts) {
                    await storage.deleteProduct(productNumber);
                }
                
                hideLoading();
                alert(`${selectedProducts.size}ä»¶ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                location.reload();
                
            } catch (error) {
                hideLoading();
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToCSV() {
            const headers = ['å•†å“ç•ªå·', 'ãƒ–ãƒ©ãƒ³ãƒ‰å', 'å•†å“å', 'è²©å£²ä¾¡æ ¼', 'å®šä¾¡', 'ç´ æ', 'åŸç”£å›½', 'ã‚«ãƒ©ãƒ¼', 'ã‚µã‚¤ã‚º'];
            const rows = allProducts.map(p => {
                const data = p.productData;
                return [
                    p.productNumber,
                    data.brandName || '',
                    data.productName,
                    data.salePrice,
                    data.originalPrice || '',
                    data.material || '',
                    data.origin || '',
                    (data.colors || []).join(','),
                    (data.sizes || []).join(',')
                ];
            });
            
            // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            const BOM = '\uFEFF';
            let csvContent = BOM;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            csvContent += headers.join(',') + '\n';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            rows.forEach(row => {
                const escapedRow = row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                csvContent += escapedRow.join(',') + '\n';
            });
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å•†å“ä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleImportArea() {
            const importArea = document.getElementById('csvImportArea');
            importArea.classList.toggle('active');
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        function handleCSVFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = parseCSV(e.target.result);
                    updateProductsFromCSV(csvData);
                } catch (error) {
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSV(csvText) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            // BOMã‚’å‰Šé™¤
            csvText = csvText.replace(/^\uFEFF/, '');
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentLine += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === '\n' && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                } else if (char !== '\r') {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            
            if (lines.length === 0) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        // CSVè¡Œã‚’ãƒ‘ãƒ¼ã‚¹
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            
            return values;
        }
        
        // CSVãƒ‡ãƒ¼ã‚¿ã§å•†å“æƒ…å ±ã‚’æ›´æ–°
        async function updateProductsFromCSV(csvData) {
            if (!csvData.length) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            showLoading();
            
            try {
                const storage = new ProductStorage();
                let updateCount = 0;
                
                for (const row of csvData) {
                    const productNumber = row['å•†å“ç•ªå·'];
                    if (!productNumber) continue;
                    
                    // æ—¢å­˜ã®å•†å“ã‚’å–å¾—
                    const products = await storage.getAllProducts();
                    const product = products.find(p => p.productNumber === productNumber);
                    
                    if (product) {
                        // æ›´æ–°å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
                        if (row['ãƒ–ãƒ©ãƒ³ãƒ‰å'] !== undefined) product.productData.brandName = row['ãƒ–ãƒ©ãƒ³ãƒ‰å'];
                        if (row['å•†å“å'] !== undefined) product.productData.productName = row['å•†å“å'];
                        if (row['è²©å£²ä¾¡æ ¼'] !== undefined) product.productData.salePrice = Number(row['è²©å£²ä¾¡æ ¼']);
                        if (row['å®šä¾¡'] !== undefined) product.productData.originalPrice = Number(row['å®šä¾¡']);
                        if (row['ç´ æ'] !== undefined) product.productData.material = row['ç´ æ'];
                        if (row['åŸç”£å›½'] !== undefined) product.productData.origin = row['åŸç”£å›½'];
                        if (row['ã‚«ãƒ©ãƒ¼'] !== undefined) {
                            product.productData.colors = row['ã‚«ãƒ©ãƒ¼'].split(',').map(c => c.trim()).filter(c => c);
                        }
                        if (row['ã‚µã‚¤ã‚º'] !== undefined) {
                            product.productData.sizes = row['ã‚µã‚¤ã‚º'].split(',').map(s => s.trim()).filter(s => s);
                        }
                        
                        // ä¿å­˜
                        await storage.saveProduct(productNumber, product.html, product.productData);
                        updateCount++;
                    }
                }
                
                hideLoading();
                if (updateCount > 0) {
                    alert(`${updateCount}ä»¶ã®å•†å“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\n\næ›´æ–°å†…å®¹ã‚’åæ˜ ã™ã‚‹ãŸã‚ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚`);
                    location.reload();
                } else {
                    alert('æ›´æ–°å¯¾è±¡ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nå•†å“ç•ªå·ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
            } catch (error) {
                hideLoading();
                alert('æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å•†å“è©³ç´°ã‚’è¡¨ç¤º
        async function viewProduct(productNumber) {
            try {
                const storage = new ProductStorage();
                const product = await storage.getProduct(productNumber);
                
                if (product && product.html) {
                    const blob = new Blob([product.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    alert('å•†å“ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                alert('å•†å“ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatNumber(num) {
            return Number(num).toLocaleString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
        const importArea = document.getElementById('csvImportArea');
        
        importArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            importArea.style.background = '#d1ecf1';
        });
        
        importArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            importArea.style.background = '#e8f4f8';
        });
        
        importArea.addEventListener('drop', (e) => {
            e.preventDefault();
            importArea.style.background = '#e8f4f8';
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                handleCSVFile(file);
            } else {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„');
            }
        });
    </script>
</body>
</html>